name: Iac With Ansible

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      OS_AUTH_URL: ${{ secrets.AUTH_URL }}
      OS_IDENTITY_API_VERSION: ${{ secrets.OS_IDENTITY_API_VERSION }}
      OS_TENANT_ID: ${{ secrets.OS_TENANT_ID }}
      OS_TENANT_NAME: ${{ secrets.OS_TENANT_NAME }}
      OS_PROJECT_ID: ${{ secrets.OS_TENANT_ID }}
      OS_PROJECT_NAME: ${{ secrets.OS_TENANT_NAME }}
      OS_USERNAME: ${{ secrets.OS_USERNAME }}
      OS_PASSWORD: ${{ secrets.OS_PASSWORD }}
      OS_USER_DOMAIN_NAME: ${{ secrets.OS_USER_DOMAIN_NAME }}
      OS_PROJECT_DOMAIN_NAME: ${{ secrets.OS_PROJECT_DOMAIN_NAME }}
      OS_REGION_NAME: ${{ secrets.OS_REGION_NAME }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_EC2_METADATA_DISABLED: "true"
      OS_AUTH_TYPE: "v3password"
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      SSH_KEY_PATH: ${{ github.workspace }}/.ssh/id_rsa
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Python dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup SSH key
        run: |
          mkdir -p "${{ github.workspace }}/.ssh"
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "${{ github.workspace }}/.ssh/id_rsa"
          chmod 600 "${{ github.workspace }}/.ssh/id_rsa"

      - name: Validate required secrets
        run: |
          set -euo pipefail
          required_vars=(
            OS_AUTH_URL OS_IDENTITY_API_VERSION OS_TENANT_ID OS_TENANT_NAME
            OS_PROJECT_ID OS_PROJECT_NAME OS_USERNAME OS_PASSWORD
            OS_REGION_NAME AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION
            TF_VAR_ssh_public_key SSH_KEY_PATH
          )
          for v in "${required_vars[@]}"; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required env var: $v"
              exit 1
            fi
          done

          if [ -z "${OS_USER_DOMAIN_NAME:-}" ]; then
            echo "OS_USER_DOMAIN_NAME=Default" >> "$GITHUB_ENV"
          fi
          if [ -z "${OS_PROJECT_DOMAIN_NAME:-}" ]; then
            echo "OS_PROJECT_DOMAIN_NAME=Default" >> "$GITHUB_ENV"
          fi

      - name: Validate OpenTofu
        run: |
          tofu fmt -check
          tofu init -input=false
          tofu validate

      - name: Validate OpenStack authentication
        run: |
          set -euo pipefail
          # Normalize potential CRLF/newline issues from copied secrets.
          export OS_AUTH_URL="$(printf '%s' "${OS_AUTH_URL}" | tr -d '\r')"
          export OS_USERNAME="$(printf '%s' "${OS_USERNAME}" | tr -d '\r')"
          export OS_PASSWORD="$(printf '%s' "${OS_PASSWORD}" | tr -d '\r')"
          export OS_TENANT_ID="$(printf '%s' "${OS_TENANT_ID}" | tr -d '\r')"
          export OS_TENANT_NAME="$(printf '%s' "${OS_TENANT_NAME}" | tr -d '\r')"
          export OS_PROJECT_ID="${OS_PROJECT_ID:-$OS_TENANT_ID}"
          export OS_PROJECT_NAME="${OS_PROJECT_NAME:-$OS_TENANT_NAME}"
          export OS_USER_DOMAIN_NAME="${OS_USER_DOMAIN_NAME:-Default}"
          export OS_PROJECT_DOMAIN_NAME="${OS_PROJECT_DOMAIN_NAME:-Default}"

          . .venv/bin/activate
          openstack token issue

      - name: Deploy Infra and Configure VM
        run: |
          . .venv/bin/activate
          ./scripts/run-playbook.sh
