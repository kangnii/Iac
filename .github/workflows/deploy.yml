name: Iac With Ansible

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      OS_AUTH_URL: ${{ secrets.OS_AUTH_URL }}
      OS_IDENTITY_API_VERSION: ${{ secrets.OS_IDENTITY_API_VERSION }}
      OS_TENANT_ID: ${{ secrets.OS_TENANT_ID }}
      OS_TENANT_NAME: ${{ secrets.OS_TENANT_NAME }}
      OS_PROJECT_ID: ${{ secrets.OS_TENANT_ID }}
      OS_PROJECT_NAME: ${{ secrets.OS_TENANT_NAME }}
      OS_USERNAME: ${{ secrets.OS_USERNAME }}
      OS_PASSWORD: ${{ secrets.OS_PASSWORD }}
      OS_USER_DOMAIN_NAME: "Default"
      OS_PROJECT_DOMAIN_NAME: "Default"
      OS_REGION_NAME: ${{ secrets.OS_REGION_NAME }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_EC2_METADATA_DISABLED: "true"
      OS_AUTH_TYPE: "v3password"
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      SSH_KEY_PATH: ${{ github.workspace }}/.ssh/id_rsa
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Python dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup SSH key
        run: |
          mkdir -p "${{ github.workspace }}/.ssh"
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "${{ github.workspace }}/.ssh/id_rsa"
          printf '%s\n' "${{ secrets.SSH_PUBLIC_KEY }}" > "${{ github.workspace }}/.ssh/id_rsa.pub"
          chmod 600 "${{ github.workspace }}/.ssh/id_rsa"
          chmod 644 "${{ github.workspace }}/.ssh/id_rsa.pub"

      - name: Validate required secrets
        run: |
          set -euo pipefail
          required_vars=(
            OS_AUTH_URL OS_IDENTITY_API_VERSION OS_TENANT_ID OS_TENANT_NAME OS_USERNAME OS_PASSWORD
            OS_REGION_NAME AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION
            TF_VAR_ssh_public_key SSH_KEY_PATH
          )
          for v in "${required_vars[@]}"; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required env var: $v"
              exit 1
            fi
          done

      - name: Validate OpenTofu
        run: |
          tofu fmt -check
          tofu init -input=false
          tofu validate

      - name: Validate OpenStack authentication
        run: |
          set -euo pipefail
          clean_secret() {
            # Remove CR/LF and surrounding quotes often introduced by copy/paste.
            printf '%s' "$1" | tr -d '\r\n' | sed -E 's/^"(.*)"$/\1/; s/^'\''(.*)'\''$/\1/'
          }

          export OS_AUTH_URL="$(clean_secret "${OS_AUTH_URL}")"
          export OS_USERNAME="$(clean_secret "${OS_USERNAME}")"
          export OS_PASSWORD="$(clean_secret "${OS_PASSWORD}")"
          export OS_TENANT_ID="$(clean_secret "${OS_TENANT_ID}")"
          export OS_TENANT_NAME="$(clean_secret "${OS_TENANT_NAME}")"
          export OS_PROJECT_ID="$OS_TENANT_ID"
          export OS_PROJECT_NAME="$OS_TENANT_NAME"
          export OS_USER_DOMAIN_NAME="$(clean_secret "${OS_USER_DOMAIN_NAME:-Default}")"
          export OS_PROJECT_DOMAIN_NAME="$(clean_secret "${OS_PROJECT_DOMAIN_NAME:-Default}")"

          # Non-sensitive debug to validate mapping.
          echo "OS_AUTH_URL=${OS_AUTH_URL}"
          echo "OS_USERNAME length=${#OS_USERNAME}"
          echo "OS_PROJECT_ID length=${#OS_PROJECT_ID}"
          echo "OS_PROJECT_NAME=${OS_PROJECT_NAME}"
          echo "OS_REGION_NAME=${OS_REGION_NAME}"
          echo "OS_USER_DOMAIN_NAME=${OS_USER_DOMAIN_NAME}"
          echo "OS_PROJECT_DOMAIN_NAME=${OS_PROJECT_DOMAIN_NAME}"

          . .venv/bin/activate
          openstack \
            --os-auth-url "$OS_AUTH_URL" \
            --os-identity-api-version "$OS_IDENTITY_API_VERSION" \
            --os-username "$OS_USERNAME" \
            --os-password "$OS_PASSWORD" \
            --os-project-id "$OS_PROJECT_ID" \
            --os-project-name "$OS_PROJECT_NAME" \
            --os-user-domain-name "$OS_USER_DOMAIN_NAME" \
            --os-project-domain-name "$OS_PROJECT_DOMAIN_NAME" \
            --os-region-name "$OS_REGION_NAME" \
            token issue

      - name: Deploy Infra and Configure VM
        run: |
          . .venv/bin/activate
          ./scripts/run-playbook.sh
